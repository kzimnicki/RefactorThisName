<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>CC</title>
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.3/jquery.mobile-1.4.3.min.css"/>
    <script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
    <script src="http://code.jquery.com/mobile/1.4.3/jquery.mobile-1.4.3.min.js"></script>
    <script id="panel-init">
        $(function () {
            $("body>[data-role='panel']").panel();
        });
    </script>
    <script type='text/javascript'>
    </script>
    <style type='text/css'>
        div {
            border: 0px solid black;
        }

        body {
            background-color: black;
        }

        div#messageBox {
            padding: 16px;
            color: white;
        }

        span {
            top: 50%;
        }

        span.text {
            font-size: 5.5vw;
            font-family: sans-serif;
        }

        span.text.translations {
            color: yellow;
        }
    </style>

</head>
<body>
<div id="page" data-role="page" data-quicklinks="true" style="background: #000000">


    <div role="main" class="ui-content jqm-content jqm-fullwidth" style="background: #000000">
        <a href="#leftpanel3" class="ui-btn-left ui-icon-bars ui-btn-icon-notext"></a>

        <div id='messageBox' style="text-align: center; display: table; height: 95%; width: 95%">
            <div style=" display:table-cell;   vertical-align: middle;">
                <span id="line1" class="text">Connecting...</span>
                <br/>
                <span id="line2" class="text"></span>
                <br/>
                <span id="cc-translation" class="text translations"></span>
            </div>
        </div>

    </div>


    <div data-role="panel" id="leftpanel3" data-position="left" data-display="overlay" data-theme="b" data-swipe-close="false">
        <a data-rel="close" class="ui-btn-right ui-icon-delete ui-btn-icon-notext"></a>

        <form class="userform">
            <h2>Options</h2>

            <label for="delay">Delay:</label>
            <input type="range" name="delay" id="delay" min="0" max="100" value="50" data-show-value="true"
                   data-highlight="true" data-popup-enabled="true">

            <div class="switch">
                <label for="cc">Closed Captions</label>
                <select name="cc" id="cc" data-role="slider">
                    <option value="off">Off</option>
                    <option selected value="on">On</option>
                </select>
            </div>

            <div class="switch">
                <label for="translations">Translations</label>
                <select name="translations" id="translations" data-role="slider">
                    <option value="off">Off</option>
                    <option selected value="on">On</option>
                </select>
            </div>

        </form>
    </div>
</div>

<script>
    $(document).one("pagecreate", "#page", function () {
        var delay = 2000;

        if (!window.WebSocket)
            alert("WebSocket not supported by this browser");

        var server = {
            connect: function (url) {
                this._ws = new WebSocket(url);
                this._ws.onopen = this._onopen;
                this._ws.onmessage = this._onmessage;
                this._ws.onclose = this._onclose;
            },

            _onopen: function () {
                server._send('Loading...');
            },

            _send: function (message) {
                if (this._ws)
                    this._ws.send(message);
            },

            send: function (text) {
                if (text != null && text.length > 0)
                    server._send(text);
            },

            _onmessage: function (m) {
                setTimeout(function () {
                    console.log(m.data);
                    if (m.data) {
                        var data = JSON.parse(m.data);
                        console.log(data);
                        $('#line1').text('');
                        $('#line2').text('');
                        $('#cc-translation').text('');
                        $('#line1').text(data.l1);
                        $('#line2').text(data.l2);

                        var translationArray = []
                        for (var key in data.translations) {
                            if (data.translations.hasOwnProperty(key)) {
                                translationArray.push(JSON.parse('"' + key + '"') + " = " + data.translations[key]);
                            }
                        }
                        $('#cc-translation').html(translationArray.join("<br/>"));
                    }
                }, delay);
            },

            _onclose: function () {
                this._ws = null;
            }
        };


        $('#delay').change(function () {
            console.log('change');
            console.log($("#delay").val());
        });

        $('#cc').change(function () {
            console.log('change');
            if($("#cc").val() === 'off'){
                $('#line1').hide();
                $('#line2').hide();
            } else {
                $('#line1').show();
                $('#line2').show();
            }
        });

        $('#translations').change(function () {
            console.log($('#cc-translation'));
            if($("#cc-translation").val() === 'off'){
                console.log($("#cc-translation").val());
                $('#cc-translation').hide();
            } else {
                $('#cc-translation').show();
            }
        });


        var loc = window.location, new_uri;
        if (loc.protocol === "https:") {
            new_uri = "wss:";
        } else {
            new_uri = "ws:";
        }
        new_uri += "//" + loc.host;
        new_uri += loc.pathname + "app/";
        server.connect(new_uri);
//        server.connect('ws://explain.cc:8888/app');
        $('#control').empty();
    });
</script>
</body>
</html>
