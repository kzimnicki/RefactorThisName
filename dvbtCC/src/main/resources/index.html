<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>CC</title>
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.3/jquery.mobile-1.4.3.min.css"/>
    <script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
    <script src="http://code.jquery.com/mobile/1.4.3/jquery.mobile-1.4.3.min.js"></script>
    <script id="panel-init">
        $(function () {
            $("body>[data-role='panel']").panel();
        });
    </script>
    <script type='text/javascript'>
    </script>
    <style type='text/css'>
        div {
            border: 0px solid black;
        }

        body {
            background-color: black;
        }

        div#messageBox {
            padding: 16px;
            color: white;
        }

        span {
            top: 50%;
        }

        span.text {
            font-size: 34px;
            font-family: verdana;
            text-shadow: 0 0 0 #000000 !important;
        }

        span.text.translations {
            color: yellow;
        }

        .transition {
            color: yellow;
            opacity: 1;
        }
        .show {
            opacity: 0.1;
            transition: opacity 2s linear;
            -ms-transition: opacity 2s linear;
            -moz-transition: opacity 2s linear;
            -webkit-transition: opacity 2s linear;
        }
    </style>

</head>
<body>
<div id="page" data-role="page" data-quicklinks="true" style="background: #000000">


    <div role="main" class="ui-content jqm-content jqm-fullwidth" style="background: #000000">
        <a href="#leftpanel3" class="ui-btn-left ui-icon-bars ui-btn-icon-notext"></a>

        <div id='messageBox' style="text-align: center; display: table; height: 95%; width: 95%">
            <div style=" display:table-cell;   vertical-align: middle;">
                <span id="line1" class="text">Connecting...</span>
                <br/>
                <span id="line2" class="text"></span>
                <br/>
                <span id="cc-translation" class="text translations">
                    <div id="translation-1"></div>
                    <div id="translation-2"></div>
                    <div id="translation-3"></div>
                    <div id="translation-4"></div>
                    <div id="translation-5"></div>
                    <div id="translation-6"></div>

                </span>
            </div>
        </div>

    </div>


    <div data-role="panel" id="leftpanel3" data-position="left" data-display="overlay" data-theme="b" data-swipe-close="false">
        <a data-rel="close" class="ui-btn-right ui-icon-delete ui-btn-icon-notext"></a>

        <form class="userform">
            <h2>Options</h2>

            <label for="delay">Delay in seconds:</label>
            <input type="range" name="delay" id="delay" min="0" max="100" value="3" data-show-value="true"
                   data-highlight="true" data-popup-enabled="true">

            <div class="switch">
                <label for="cc">Closed Captions</label>
                <select name="cc" id="cc" data-role="slider">
                    <option value="off">Off</option>
                    <option selected value="on">On</option>
                </select>
            </div>

            <div class="switch">
                <label for="translations">Translations</label>
                <select name="translations" id="translations" data-role="slider">
                    <option value="off">Off</option>
                    <option selected value="on">On</option>
                </select>
            </div>

        </form>
    </div>
</div>

<script>
    $(document).one("pagecreate", "#page", function () {
        var delay = 2000;

        var speedCounterStartDate = new Date().getTime();
        var ccCounter = 0;
        var pointer = 0;
        var length = 6;


        if (!window.WebSocket)
            alert("WebSocket not supported by this browser");

        var server = {
            connect: function (url) {
                this._ws = new WebSocket(url);
                this._ws.onopen = this._onopen;
                this._ws.onmessage = this._onmessage;
                this._ws.onclose = this._onclose;
            },

            _onopen: function () {
                server._send('Loading...');
            },

            _send: function (message) {
                if (this._ws)
                    this._ws.send(message);
            },

            send: function (text) {
                if (text != null && text.length > 0)
                    server._send(text);
            },

            _onmessage: function (m) {
                if (++ccCounter === 5){
                   console.log('Speed: ', (new Date().getTime() - speedCounterStartDate)/1000);
                   speedCounterStartDate = new Date().getTime();
                   ccCounter = 0;
                }

                setTimeout(function () {
                    console.log(m.data);
                    if (m.data) {
                        var data = JSON.parse(m.data);
                        console.log(data);
                        $('#line1').text('');
                        $('#line2').text('');
//                        $('#cc-translation').text('');
                        $('#line1').text(data.l1);
                        $('#line2').text(data.l2);


                        for (var key in data.translations) {
                            if (data.translations.hasOwnProperty(key)) {
                                var jsonData = {
                                    word : JSON.parse('"' + key + '"'),
                                    translation: data.translations[key]
                                };

                                pointer = (length+pointer)%length;

                                console.log(Math.floor(pointer));
                                console.log($('#translation-'+Math.round(pointer)));
                                $('#translation-'+Math.round(pointer)).text(jsonData.word+' = '+jsonData.translation)
                                pointer++;
                            }
                        }

//                        for(var i=0; i<circularBuffer.get().length; i++){
//                            var data = circularBuffer.get()[i];
//                            console.log(data);
//                            var object = $('<div class="transition">'+data.word+' = '+data.translation+'</div>');
//                            console.log(object);
//                            $('#cc-translation').append(object);
//
//                            setTimeout(function(){
//                                        console.log('added');
//                                        object.addClass('show');
//                                    }
//                                    , 100);
//
//                        }


                    }
                }, delay);
            },

            _onclose: function () {
                this._ws = null;
            }
        };


        $('#delay').change(function () {
            console.log('change');
            console.log($("#delay").val());
        });

        $('#cc').change(function () {
            console.log('change');
            if($("#cc").val() === 'off'){
                $('#line1').hide();
                $('#line2').hide();
            } else {
                $('#line1').show();
                $('#line2').show();
            }
        });

        $('#translations').change(function () {
            if($('#translations').val() === 'off'){
                $('#cc-translation').hide();
            } else {
                $('#cc-translation').show();
            }
        });


        var loc = window.location, new_uri;
        if (loc.protocol === "https:") {
            new_uri = "wss:";
        } else {
            new_uri = "ws:";
        }
        new_uri += "//" + loc.host;
        new_uri += loc.pathname + "app/";
       //server.connect(new_uri);
        server.connect('ws://explain.cc:8888/app');
        $('#control').empty();
    });
</script>
</body>
</html>
